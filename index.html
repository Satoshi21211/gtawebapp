// index.js
// Telegram IRL-–∫–≤–µ—Å—Ç-–±–æ—Ç: –∑–∞–¥–∞–Ω–∏—è, –ø—Ä–∏—ë–º —Ñ–æ—Ç–æ/–≥–µ–æ, –ø—Ä–æ–≥—Ä–µ—Å—Å.
// by Code Companion

import 'dotenv/config';
import { Telegraf } from 'telegraf';
import fs from 'fs';

const BOT_TOKEN = process.env.BOT_TOKEN;
if (!BOT_TOKEN) {
  console.error('–ù–µ –Ω–∞–π–¥–µ–Ω BOT_TOKEN –≤ .env');
  process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);

// ====== –ö–æ–Ω—Ñ–∏–≥ –∑–∞–¥–∞–Ω–∏–π ======
// proofType: 'photo' | 'location'
// –î–ª—è location –∑–∞–¥–∞—ë–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ —Ä–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö.
const TASKS = [
  {
    id: 1,
    title: '–§–æ—Ç–æ —Å –∑–µ–ª—ë–Ω–æ–π –¥–≤–µ—Ä—å—é',
    description: '–ù–∞–π–¥–∏ –ª—é–±—É—é –∑–µ–ª—ë–Ω—É—é –¥–≤–µ—Ä—å –≤ –≥–æ—Ä–æ–¥–µ –∏ —Å–¥–µ–ª–∞–π —Ñ–æ—Ç–æ.',
    proofType: 'photo',
    points: 10,
  },
  {
    id: 2,
    title: '–ü–∞—Ä–∫ —É —Ñ–æ–Ω—Ç–∞–Ω–∞',
    description:
      '–ü–æ–¥–æ–π–¥–∏ –∫ —Ñ–æ–Ω—Ç–∞–Ω—É –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–º –ø–∞—Ä–∫–µ –∏ –ø—Ä–∏—à–ª–∏ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é (—Ä–∞–¥–∏—É—Å 100–º).',
    proofType: 'location',
    target: { lat: 55.751244, lon: 37.618423 }, // –ü—Ä–∏–º–µ—Ä: —Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤—ã ‚Äî –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π POI
    radiusM: 100,
    points: 20,
  },
  {
    id: 3,
    title: '–§–æ—Ç–æ –∫–æ–º–∞–Ω–¥—ã',
    description: '–°–¥–µ–ª–∞–π –≥—Ä—É–ø–ø–æ–≤–æ–µ —Ñ–æ—Ç–æ –º–∏–Ω–∏–º—É–º –∏–∑ 3 –ª—é–¥–µ–π (—Å–µ–ª—Ñ–∏ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è).',
    proofType: 'photo',
    points: 15,
  },
];

// ====== –ü—Ä–æ—Å—Ç–∞—è –±–∞–∑–∞ (JSON) ======
const DB_FILE = 'progress.json';
function loadDB() {
  if (!fs.existsSync(DB_FILE)) return { users: {} };
  try {
    return JSON.parse(fs.readFileSync(DB_FILE, 'utf8'));
  } catch {
    return { users: {} };
  }
}
function saveDB(db) {
  fs.writeFileSync(DB_FILE, JSON.stringify(db, null, 2), 'utf8');
}

let db = loadDB();

// ====== –£—Ç–∏–ª–∏—Ç—ã ======
function ensureUser(userId) {
  if (!db.users[userId]) {
    db.users[userId] = {
      acceptedTaskId: null,
      completed: [], // [{taskId, proof, at}]
      points: 0,
    };
  }
  return db.users[userId];
}

function formatTasks() {
  return TASKS.map(
    (t) =>
      `#${t.id} ‚Äî ${t.title}\n` +
      `–¢–∏–ø: ${t.proofType === 'photo' ? 'üì∑ —Ñ–æ—Ç–æ' : 'üìç –ª–æ–∫–∞—Ü–∏—è'}\n` +
      (t.proofType === 'location'
        ? `–¶–µ–ª—å –≤ —Ä–∞–¥–∏—É—Å–µ ${t.radiusM}–º\n`
        : '') +
      `–û—á–∫–∏: ${t.points}\n` +
      `${t.description}`
  ).join('\n\n');
}

function haversineDistanceM(lat1, lon1, lat2, lon2) {
  const toRad = (d) => (d * Math.PI) / 180;
  const R = 6371000; // m
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
      Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) ** 2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

function getTaskById(id) {
  return TASKS.find((t) => t.id === id);
}

// ====== –ö–æ–º–∞–Ω–¥—ã ======
bot.start((ctx) => {
  ensureUser(String(ctx.from.id));
  ctx.reply(
    '–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è IRL-–∑–∞–¥–∞–Ω–∏–π üôå\n\n' +
      '–ö–æ–º–∞–Ω–¥—ã:\n' +
      '‚Ä¢ /tasks ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞–Ω–∏–π\n' +
      '‚Ä¢ /accept <id> ‚Äî –ø—Ä–∏–Ω—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ\n' +
      '‚Ä¢ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ ‚Äî –∑–∞—á—Ç—É –∑–∞–¥–∞–Ω–∏—è —Å —Ç–∏–ø–æ–º üì∑\n' +
      '‚Ä¢ –û—Ç–ø—Ä–∞–≤—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é ‚Äî –∑–∞—á—Ç—É –∑–∞–¥–∞–Ω–∏—è —Å —Ç–∏–ø–æ–º üìç\n' +
      '‚Ä¢ /progress ‚Äî —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å'
  );
});

bot.command('tasks', (ctx) => {
  ctx.reply('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:\n\n' + formatTasks());
});

bot.command('accept', (ctx) => {
  const user = ensureUser(String(ctx.from.id));
  const parts = ctx.message.text.trim().split(/\s+/);
  const id = Number(parts[1]);
  if (!id || !getTaskById(id)) {
    return ctx.reply('–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π id: /accept <id>. –ü–æ—Å–º–æ—Ç—Ä–∏ /tasks');
  }
  if (user.completed.some((c) => c.taskId === id)) {
    return ctx.reply('–≠—Ç–æ –∑–∞–¥–∞–Ω–∏–µ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ üëç. –í—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–µ.');
  }
  user.acceptedTaskId = id;
  saveDB(db);
  const task = getTaskById(id);
  ctx.reply(
    `–ü—Ä–∏–Ω—è—Ç–æ –∑–∞–¥–∞–Ω–∏–µ #${task.id}: ${task.title}\n` +
      `–û–ø–∏—Å–∞–Ω–∏–µ: ${task.description}\n` +
      `–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ: ${
        task.proofType === 'photo' ? 'üì∑ —Ñ–æ—Ç–æ' : 'üìç –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è'
      }`
  );
});

bot.command('progress', (ctx) => {
  const user = ensureUser(String(ctx.from.id));
  if (user.completed.length === 0) {
    return ctx.reply('–ü–æ–∫–∞ –Ω–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π. –ù–∞—á–Ω–∏ —Å /tasks');
  }
  const lines = user.completed
    .map((c) => {
      const t = getTaskById(c.taskId);
      const when = new Date(c.at).toLocaleString();
      return `#${t.id} ${t.title} ‚Äî +${t.points} –æ—á–∫–æ–≤ (${when})`;
    })
    .join('\n');
  ctx.reply(`–¢–≤–æ–∏ –æ—á–∫–∏: ${user.points}\n–í—ã–ø–æ–ª–Ω–µ–Ω–æ:\n${lines}`);
});

// ====== –ü—Ä–∏—ë–º –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤ ======
bot.on('photo', async (ctx) => {
  const user = ensureUser(String(ctx.from.id));
  if (!user.acceptedTaskId) {
    return ctx.reply('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–∏ –∑–∞–¥–∞–Ω–∏–µ: /accept <id>');
  }
  const task = getTaskById(user.acceptedTaskId);
  if (!task) return ctx.reply('–¢–∞–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ—Ç. –í—ã–±–µ—Ä–∏ /tasks');

  if (task.proofType !== 'photo') {
    return ctx.reply('–î–ª—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è üìç, –∞ –Ω–µ —Ñ–æ—Ç–æ.');
  }

  // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ: —Å–æ—Ö—Ä–∞–Ω—è–µ–º file_id –≤ –ø—Ä–æ–≥—Ä–µ—Å—Å (–±–µ–∑ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è).
  const photos = ctx.message.photo;
  const best = photos[photos.length - 1];
  completeTask(ctx, user, task, { type: 'photo', file_id: best.file_id });
});

bot.on('location', (ctx) => {
  const user = ensureUser(String(ctx.from.id));
  if (!user.acceptedTaskId) {
    return ctx.reply('–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–∏ –∑–∞–¥–∞–Ω–∏–µ: /accept <id>');
  }
  const task = getTaskById(user.acceptedTaskId);
  if (!task) return ctx.reply('–¢–∞–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –±–æ–ª—å—à–µ –Ω–µ—Ç. –í—ã–±–µ—Ä–∏ /tasks');

  if (task.proofType !== 'location') {
    return ctx.reply('–î–ª—è —ç—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è –Ω—É–∂–Ω–æ —Ñ–æ—Ç–æ üì∑, –∞ –Ω–µ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—è.');
  }

  const { latitude, longitude } = ctx.message.location;
  const dist = haversineDistanceM(
    latitude,
    longitude,
    task.target.lat,
    task.target.lon
  );

  if (dist <= task.radiusM) {
    completeTask(ctx, user, task, {
      type: 'location',
      lat: latitude,
      lon: longitude,
      dist: Math.round(dist),
    });
  } else {
    ctx.reply(
      `–¢—ã –≤–Ω–µ –∑–æ–Ω—ã —Ü–µ–ª–∏: ${Math.round(dist)}–º. –ù—É–∂–Ω–æ ‚â§ ${task.radiusM}–º. –ü–æ–¥–æ–π–¥–∏ –±–ª–∏–∂–µ –∏ –ø—Ä–∏—à–ª–∏ –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é –µ—â—ë —Ä–∞–∑.`
    );
  }
});

// ====== –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è ======
function completeTask(ctx, user, task, proof) {
  user.completed.push({
    taskId: task.id,
    proof,
    at: Date.now(),
    points: task.points,
  });
  user.points += task.points;
  user.acceptedTaskId = null;
  saveDB(db);

  ctx.reply(
    `–ó–∞–¥–∞–Ω–∏–µ #${task.id} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ! üéâ +${task.points} –æ—á–∫–æ–≤.\n` +
      `–•–æ—á–µ—à—å –µ—â—ë? –ü–æ—Å–º–æ—Ç—Ä–∏ /tasks`
  );
}

// ====== –ó–∞–ø—É—Å–∫ ======
bot.launch().then(() => {
  console.log('‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω');
});

// –ì—Ä–µ–π—Å—Ñ—É–ª-—à–∞—Ç–¥–∞—É–Ω –¥–ª—è Heroku/Render –∏ —Ç.–ø.
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
